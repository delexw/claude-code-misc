# routine

A Claude Code plugin that orchestrates JIRA ticket implementation end-to-end: fetches ticket details, discovers domain knowledge, scans linked resources and designs, optimizes the prompt, then executes the task.

## Setup

### Required

| Dependency | Description |
|---|---|
| [jira-cli](https://github.com/ankitpokhrel/jira-cli) | Jira CLI tool |
| [confluence-cli](https://github.com/pchuri/confluence-cli) | Confluence CLI tool |
| `JIRA_API_TOKEN` | [Jira API token](https://id.atlassian.com/manage-profile/security/api-tokens) — set as env var |

### Optional

| Dependency | Description |
|---|---|
| [Figma MCP](https://github.com/nichochar/figma-mcp) | Read Figma designs from ticket links |
| `PROMPT_EVAL_API_KEY` | Prompt optimization via [meta-prompter](https://github.com/delexw/claude-code-misc/tree/main/.claude/mcp/meta-prompter#cli) |
| `PROMPT_EVAL_MODEL` | Model for prompt evaluation (default: `anthropic:claude-sonnet-4-5`). Format: `provider:model-id` |

## Usage

```
/routine:implement <JIRA-URL> ["optional context"]
```

Example:
```
/routine:implement https://myco.atlassian.net/browse/PROJ-123
```

## Skills

| Skill | Command | Description |
|---|---|---|
| `implement` | `/routine:implement` | Orchestrator — runs all phases end-to-end |
| `jira-ticket-viewer` | `/routine:jira-ticket-viewer` | Fetches and parses JIRA tickets via `--raw` JSON |
| `confluence-page-viewer` | `/routine:confluence-page-viewer` | Reads Confluence pages |
| `figma-reader` | `/routine:figma-reader` | Reads Figma designs via MCP |
| `domain-discover` | `/routine:domain-discover` | Discovers codebase domain knowledge |
| `meta-prompter` | `/routine:meta-prompter` | Evaluates and optimizes prompts before execution |

## Architecture

### Execution Flow

Phases 3 and 4 run in parallel — all sub-skills are launched concurrently after Phase 2 completes.

```
P1 Pre-flight ──► P2 JIRA Analysis ──┬──► P3 Domain Discovery (concurrent per domain)  ──┬──► P5 Prompt Optimization ──► P6 Execute ──► P7 Verify
                                      └──► P4 Resource Scanning (links + Figma concurrent) ──┘
```

### Hooks

The `implement` skill uses hooks for automatic execution tracking:

| Hook | Trigger | Action |
|---|---|---|
| `PreToolUse` (Skill) | Before each sub-skill call | Logs `start` entry to `execution-log.jsonl` |
| `PostToolUse` (Skill) | After each sub-skill call | Logs `end` entry to `execution-log.jsonl` |
| `Stop` (once) | When Claude finishes | Generates Mermaid Gantt chart from log |
| `SessionEnd` | Session terminates | Cleans up `.implement-assets/` |

### Output Persistence

Sub-skills with `context: fork` run as subagents. Each persists its full output to `OUT_DIR/output.md` so the orchestrator reads the complete result (not the summarized subagent return).

```
.implement-assets/{ticket_id}/
├── jira/                  # jira-ticket-viewer output
├── domains/               # domain-discover output per domain
├── linked-jira/           # linked ticket outputs
├── confluence/            # confluence page outputs
├── figma/                 # figma design outputs
├── execution-log.jsonl    # auto-generated by hooks
└── execution-flow.md      # Mermaid Gantt chart
```
