# routine

A Claude Code plugin that orchestrates JIRA ticket implementation end-to-end: fetches ticket details, discovers domain knowledge, scans linked resources and designs, optimizes the prompt, then executes the task.

## Installation

### Option 1: Skills (Recommended)

Install directly to `~/.claude/skills/` using the [Agent Skills](https://agentskills.io) CLI. This is the recommended approach as it avoids known plugin limitations with [hooks](https://github.com/anthropics/claude-code/issues/17688), [model/context/agent](https://github.com/anthropics/claude-code/issues/16803), and [script paths](https://github.com/anthropics/claude-code/issues/11011) not working correctly in plugins.

```bash
npx skills add https://github.com/delexw/claude-code-misc
```

To update to the latest version:

```bash
npx skills update
```

Skills installed this way are available across all your projects without the `routine:` prefix (e.g. `/implement` instead of `/routine:implement`).

### Option 2: Plugin

First add the marketplace, then install the plugin:

```bash
/plugin marketplace add delexw/claude-code-misc
/plugin install routine@delexw-claude-code-misc
```

Or load directly for local development:

```bash
claude --plugin-dir ./path/to/plugins/routine
```

> **Known plugin limitations:**
> - [Skill-scoped hooks not triggered in plugins](https://github.com/anthropics/claude-code/issues/17688) — execution tracing won't work
> - [`context: fork`, `agent`, `model` frontmatter ignored](https://github.com/anthropics/claude-code/issues/16803) — skills run inline instead of as subagents
> - [Relative script paths fail in plugins](https://github.com/anthropics/claude-code/issues/11011) — scripts can't find their own directory

## Setup

### Required

| Dependency | Description |
|---|---|
| [jira-cli](https://github.com/ankitpokhrel/jira-cli) | Jira CLI tool |
| [confluence-cli](https://github.com/pchuri/confluence-cli) | Confluence CLI tool |
| `JIRA_API_TOKEN` | [Jira API token](https://id.atlassian.com/manage-profile/security/api-tokens) — set as env var |

### Optional

| Dependency | Description |
|---|---|
| [Figma MCP](https://github.com/nichochar/figma-mcp) | Read Figma designs from ticket links |
| `PROMPT_EVAL_API_KEY` | Prompt optimization via [meta-prompter](https://github.com/delexw/claude-code-misc/tree/main/.claude/mcp/meta-prompter#cli) |
| `PROMPT_EVAL_MODEL` | Model for prompt evaluation (default: `anthropic:claude-sonnet-4-5`). Format: `provider:model-id` |

## Usage

```
/routine:implement <JIRA-URL> ["optional context"]
```

Example:
```
/routine:implement https://myco.atlassian.net/browse/PROJ-123
```

## Skills

| Skill | Command | Description |
|---|---|---|
| `implement` | `/routine:implement` | Orchestrator — runs all phases end-to-end |
| `jira-ticket-viewer` | `/routine:jira-ticket-viewer` | Fetches and parses JIRA tickets via `--raw` JSON |
| `confluence-page-viewer` | `/routine:confluence-page-viewer` | Reads Confluence pages |
| `figma-reader` | `/routine:figma-reader` | Reads Figma designs via MCP |
| `domain-discover` | `/routine:domain-discover` | Discovers codebase domain knowledge |
| `meta-prompter` | `/routine:meta-prompter` | Evaluates and optimizes prompts before execution |

## Architecture

### Execution Flow

```
P1  Pre-flight Validation
│
▼
P2  JIRA Analysis (jira-ticket-viewer)
│
├──────────────────────┐
▼                      ▼
P3  Domain Discovery   P4  Resource Scanning
    (concurrent per        ├── Links (concurrent)
     domain)               │   ├── Confluence pages
                           │   ├── Linked JIRA tickets
                           │   └── GitHub / other URLs
                           └── Figma designs (figma-reader)
│                      │
└──────────────────────┘
│
▼
P5  Prompt Optimization (meta-prompter)
│
▼
P6  Execute <FINAL_PROMPT>
│
▼
P7  Change Verification
```

### Hooks

The `implement` skill uses hooks for automatic execution tracking:

| Hook | Trigger | Action |
|---|---|---|
| `PreToolUse` (Skill) | Before each sub-skill call | Logs `start` entry to `execution-log.jsonl` |
| `PostToolUse` (Skill) | After each sub-skill call | Logs `end` entry to `execution-log.jsonl` |
| `Stop` (once) | When Claude finishes | Generates Mermaid Gantt chart from log |
| `SessionEnd` | Session terminates | Cleans up `.implement-assets/` |

### Output Persistence

Sub-skills with `context: fork` run as subagents. Each persists its full output to `OUT_DIR/output.md` so the orchestrator reads the complete result (not the summarized subagent return).

```
.implement-assets/
├── execution-log.jsonl        # auto-generated by hooks (root level)
├── execution-flow.md          # Mermaid Gantt chart (root level)
└── {ticket_id}/
    ├── jira/                  # jira-ticket-viewer output
    ├── domains/               # domain-discover output per domain
    ├── linked-jira/           # linked ticket outputs
    ├── confluence/            # confluence page outputs
    └── figma/                 # figma design outputs
```
